---
layout: post
title: "LayerZero Omnichain Fungible Tokens Adapter"
date: "2025-02-10 10:56:44 +0900"
tags: [blockchain]
---

# LayerZero

# Overview

[ì´ì „ í¬ìŠ¤íŒ…](/2025/02/06/layerzero-2/)ì—ì„œ LayerZeroë¥¼ ì‚¬ìš©í•˜ì—¬ ONFT(Omnichain Non-Fungible Tokens)ë¥¼ ë°°í¬í•˜ê³  ì‹¤í–‰í•˜ëŠ” ê³¼ì •ì„ ë‹¤ë¤„ë³´ì•˜ìŠµë‹ˆë‹¤.

ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„  OFTAdapter(Omnichain Fungible Tokens Adapter)ë¥¼ ë°°í¬í•˜ê³  ì‹¤í–‰í•˜ëŠ” ê³¼ì •ì„ ë‹¤ë¤„ë³´ê² ìŠµë‹ˆë‹¤.

# LayerZero V2 OFTAdapter

ERC20ì˜ `safeTransferFrom`ì„ ì‚¬ìš©í•˜ì—¬ spenderë¡œë¶€í„° OFT Adapter ì»¨íŠ¸ë™íŠ¸ë¡œ í† í°ì„ ì „ì†¡í•˜ë©´, í˜ì–´ë§ëœ OFT ì»¨íŠ¸ë™íŠ¸ë¥¼ í†µí•´ ì„ íƒí•œ ëŒ€ìƒ ì²´ì¸(Chain B)ì—ì„œ ë™ì¼í•œ ìˆ˜ëŸ‰ì˜ í† í°ì´ `_mint` ë©ë‹ˆë‹¤.

ì†ŒìŠ¤ ì²´ì¸ì˜ OFT Adapterì— ìˆëŠ” í† í°ì„ lockí•˜ë ¤ë©´ `OFT.send`(Chain B)ë¥¼ í˜¸ì¶œí•´ì•¼ í•˜ë©°, ì´ë¡œ ì¸í•´ í† í°ì´ `_burn`ë˜ê³  í”„ë¡œí† ì½œì„ í†µí•´ ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì–´ Adapterì—ì„œ ìˆ˜ì‹  ì£¼ì†Œ(Chain A)ë¡œ `ERC20.safeTransfer`ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.

![image.png](/assets/post/2025-02-10-layerzero-3/image%2017.png)

## Installation

ì•„ë˜ ëª…ë ¹ì–´ë¡œ OFTAdapterê°€ í¬í•¨ëœ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`OFTAdapter` ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ í”„ë¡œì íŠ¸ì— OFTê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```bash
npx create-lz-oapp
```

![image.png](/assets/post/2025-02-10-layerzero-3/image%2018.png)

ì´í›„ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒ¨í‚¤ì§€ë¥¼ ì¶”ê°€ ì„¤ì¹˜ í•´ì¤ë‹ˆë‹¤.

```bash
pnpm add @layerzerolabs/oft-evm
```

## Deploy

1. ERC20 Token ì»¨íŠ¸ë™íŠ¸ ë°°í¬
    
    OFTAdapterë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„  ê¸°ì¡´ ë°°í¬ë˜ì–´ ìˆëŠ” ERC20 Token ì»¨íŠ¸ë™íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.
    
    í…ŒìŠ¤íŠ¸ í™˜ê²½ì´ê¸° ë•Œë¬¸ì— ì§ì ‘ ë°°í¬í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.
    
2. `hardhat.config.ts` êµ¬ì„±
    
    ë³¸ë¬¸ì—ì„œëŠ” amoyë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì„ê±°ë¼ ì œê±°í–ˆìŒ
    
    oftAdapter ë¶€ë¶„ì— 0ë²ˆ ê³¼ì •ì—ì„œ ë°°í¬í•œ tokenAddressë¥¼ ì…ë ¥ í•´ ì£¼ì—ˆìŒ
    
    ![image.png](/assets/post/2025-02-10-layerzero-3/image%2019.png)
    
3. ë¹Œë“œ
    
    ```bash
    pnpm install # Install dependencies
    pnpm compile # Compile contract
    ```
    
    ![image.png](/assets/post/2025-02-10-layerzero-3/image%2020.png)
    
4. `.env` êµ¬ì„±
    - RenameÂ `.env.example`Â ->Â `.env`
    - Choose your preferred means of setting up your deployer wallet/account:
    
    ```toml
    MNEMONIC="test test test test test test test test test test test junk"
    or...
    PRIVATE_KEY="0xabc...def"
    ```
    
5. ë°°í¬
    
    ```toml
    npx hardhat lz:deploy
    ```
    
    `OFTAdapter` ì„¤ì •ì„ ì¶”ê°€í•´ì£¼ì—ˆê¸° ë•Œë¬¸ì— sepoliaì—ëŠ” OFTAdapterë§Œ ë°°í¬ ë˜ì—ˆìŠµë‹ˆë‹¤.
    
    ![image.png](/assets/post/2025-02-10-layerzero-3/image%2021.png)
    
6. `layerzero.config.ts` êµ¬ì„±
    
    ì‹¤ì œ ì»¨íŠ¸ë™íŠ¸ë¥¼ ì—°ê²°í•  ì²´ì¸ë“¤ì„ êµ¬ì„±
    
    ë³¸ë¬¸ì—ì„œëŠ” amoyë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ì œê±°í–ˆìŒ
    
    ![image.png](/assets/post/2025-02-10-layerzero-3/image%209.png)
    
7. Contract wire
    
    ```bash
    npx hardhat lz:oapp:wire --oapp-config layerzero.config.ts
    ```
    
    ![image.png](/assets/post/2025-02-10-layerzero-3/image%2022.png)
    
8. ERC20.approve ìˆ˜í–‰
    - ERC20 í† í°ì— ëŒ€í•´ì„œ OFTAdapterê°€ ì»¨íŠ¸ë¡¤ í•  ìˆ˜ ìˆë„ë¡ approveë¥¼ ìˆ˜í–‰í•´ì¤ë‹ˆë‹¤.
    - spenderëŠ” OFTAdapter ì…ë‹ˆë‹¤.
9. sendToken ìƒì„± í›„ ì‹¤í–‰
    
    ```tsx
    // tasks/sendToken.ts
    
    import { task } from 'hardhat/config';
    import { HardhatRuntimeEnvironment } from 'hardhat/types';
    
    import { Options } from '@layerzerolabs/lz-v2-utilities';
    
    export default task('sendToken', 'Send a token to the destination chain')
        .addParam('dstNetwork', 'The destination network name (from hardhat.config.ts)')
        .addParam('amount', 'The amount of tokens to send')
        .setAction(async (taskArgs, hre: HardhatRuntimeEnvironment) => {
            const { amount, dstNetwork } = taskArgs;
            const [signer] = await hre.ethers.getSigners();
    
            const addressAsBytes32 = "0x0000000000000000000000002f32e86e8fc5e762aa32a09d4970cb3216fefaf4";
    
            // Get destination network's EID
            const dstNetworkConfig = hre.config.networks[dstNetwork];
            const dstEid = dstNetworkConfig.eid;
    
            // Get current network's EID
            const srcNetworkConfig = hre.config.networks[hre.network.name];
            const srcEid = srcNetworkConfig?.eid;
    
            console.log('Sending message:');
            console.log('- From:', signer.address);
            console.log('- Source network:', hre.network.name, srcEid ? `(EID: ${srcEid})` : '');
            console.log('- Destination:', dstNetwork || 'unknown network', `(EID: ${dstEid})`);
            console.log('- Amount:', amount);
    
            const myOFTAdapter = await hre.deployments.get('MyOFTAdapter');
            const contract = await hre.ethers.getContractAt('MyOFTAdapter', myOFTAdapter.address, signer);
    
            // Add executor options with gas limit
            const options = Options.newOptions().addExecutorLzReceiveOption(200000, 0).toBytes();
    
            // Get quote for the message
            console.log('Getting quote...');
            const sendParam = {
                dstEid: dstEid,
                to: addressAsBytes32,
                amountLD: amount,
                minAmountLD: amount,
                extraOptions: options,
                composeMsg: "0x00",
                oftCmd: "0x00"
            }
            const quotedFee = await contract.quoteSend(sendParam, false);
            console.log('Quoted fee:', hre.ethers.utils.formatEther(quotedFee.nativeFee));
    
            // Send the message
            console.log('Sending tokens...');
            const tx = await contract.send(sendParam, quotedFee, signer.address, {value: quotedFee.nativeFee});
    
            const receipt = await tx.wait();
            console.log('ğŸ‰ Tokens sent! Transaction hash:', receipt.transactionHash);
            console.log(
                'Check token balance on LayerZero Scan: https://testnet.layerzeroscan.com/tx/' +
                receipt.transactionHash,
            );
        });
    ```
    
    ```tsx
    import { EndpointId } from '@layerzerolabs/lz-definitions'
    
    import "./tasks/sendToken" // ì¶”ê°€
    ```
    
    ```bash
    npx hardhat sendToken --network sepolia-testnet --dst-network avalanche-testnet --amount 100000000000000000
    ```
    
    ![image.png](/assets/post/2025-02-10-layerzero-3/image%2023.png)
    
    - ì•„ë˜ì™€ ê°™ì´ LayerZero Explorerì—ì„œë„ í™•ì¸í•  ìˆ˜ ìˆìŒ
        
        ![image.png](/assets/post/2025-02-10-layerzero-3/image%2024.png)
        
    - Source Chainì—ì„œ ì²˜ë¦¬ ë¨
        
        ![image.png](/assets/post/2025-02-10-layerzero-3/image%2025.png)
        
    - ì‹¤ì œ Fuji chainì— ì „ì†¡ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ
        
        ![image.png](/assets/post/2025-02-10-layerzero-3/image%2026.png)
        

## **OFTAdapter Setup for Both Chains**

ìœ„ì—ì„œëŠ” í•œìª½ì€ OFTAdapter, í•œìª½ì€ OFT ì»¨íŠ¸ë™íŠ¸ë¥¼ ì‚¬ìš©í•œ ì˜ˆì‹œë¥¼ ë³´ì—¬ë“œë ¸ìŠµë‹ˆë‹¤.

ì§€ê¸ˆë¶€í„°ëŠ” ì–‘ìª½ì— ëª¨ë‘ OFTAdpterë¥¼ ì‚¬ìš©í•˜ì—¬ ë°°í¬í•œ ë’¤ ì‹¤ì œ ì „ì†¡ì„ ì²˜ë¦¬í•´ë´…ë‹ˆë‹¤.

ìœ„ ê³¼ì •ê³¼ ì¼ë¶€ ê²¹ì¹˜ëŠ” ë¶€ë¶„ì´ ìˆê¸° ë•Œë¬¸ì— ì¼ë¶€ ë‚´ìš©ì´ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤.

### Deploy

1. `hardhat.config.ts` ì„¤ì •
    
    ì–‘ìª½ ì²´ì¸ ëª¨ë‘ `oftAdapter` ì„¤ì •
    
    ![image.png](/assets/post/2025-02-10-layerzero-3/image%2027.png)
    
2. ë¹Œë“œ
    
    ```bash
    pnpm install # Install dependencies
    pnpm compile # Compile contract
    ```
    
3. ë°°í¬
    
    ```bash
    npx hardhat lz:deploy
    ```
    
4. Contract wiring
    
    `layerzero.config.ts` ì— contractName í™•ì¸
    
    ![image.png](/assets/post/2025-02-10-layerzero-3/image%2028.png)
    
    ```bash
    npx hardhat lz:oapp:wire --oapp-config layerzero.config.ts
    ```
    
    ![image.png](/assets/post/2025-02-10-layerzero-3/image%2029.png)
    
5. ERC20.approve ìˆ˜í–‰
    - ERC20 í† í°ì— ëŒ€í•´ì„œ OFTAdapterê°€ ì»¨íŠ¸ë¡¤ í•  ìˆ˜ ìˆë„ë¡ approveë¥¼ ìˆ˜í–‰í•´ì¤ë‹ˆë‹¤.
    - spenderëŠ” OFTAdapter ì…ë‹ˆë‹¤.
6. sendToken ìƒì„± í›„ ì‹¤í–‰
    
    ```tsx
    // tasks/sendToken.ts
    
    import { task } from 'hardhat/config';
    import { HardhatRuntimeEnvironment } from 'hardhat/types';
    
    import { Options } from '@layerzerolabs/lz-v2-utilities';
    
    export default task('sendToken', 'Send a token to the destination chain')
        .addParam('dstNetwork', 'The destination network name (from hardhat.config.ts)')
        .addParam('amount', 'The amount of tokens to send')
        .setAction(async (taskArgs, hre: HardhatRuntimeEnvironment) => {
            const { amount, dstNetwork } = taskArgs;
            const [signer] = await hre.ethers.getSigners();
    
            const addressAsBytes32 = "0x0000000000000000000000002f32e86e8fc5e762aa32a09d4970cb3216fefaf4";
    
            // Get destination network's EID
            const dstNetworkConfig = hre.config.networks[dstNetwork];
            const dstEid = dstNetworkConfig.eid;
    
            // Get current network's EID
            const srcNetworkConfig = hre.config.networks[hre.network.name];
            const srcEid = srcNetworkConfig?.eid;
    
            console.log('Sending message:');
            console.log('- From:', signer.address);
            console.log('- Source network:', hre.network.name, srcEid ? `(EID: ${srcEid})` : '');
            console.log('- Destination:', dstNetwork || 'unknown network', `(EID: ${dstEid})`);
            console.log('- Amount:', amount);
    
            const myOFTAdapter = await hre.deployments.get('MyOFTAdapter');
            const contract = await hre.ethers.getContractAt('MyOFTAdapter', myOFTAdapter.address, signer);
    
            // Add executor options with gas limit
            const options = Options.newOptions().addExecutorLzReceiveOption(200000, 0).toBytes();
    
            // Get quote for the message
            console.log('Getting quote...');
            const sendParam = {
                dstEid: dstEid,
                to: addressAsBytes32,
                amountLD: amount,
                minAmountLD: amount,
                extraOptions: options,
                composeMsg: "0x00",
                oftCmd: "0x00"
            }
            const quotedFee = await contract.quoteSend(sendParam, false);
            console.log('Quoted fee:', hre.ethers.utils.formatEther(quotedFee.nativeFee));
    
            // Send the message
            console.log('Sending tokens...');
            const tx = await contract.send(sendParam, quotedFee, signer.address, {value: quotedFee.nativeFee});
    
            const receipt = await tx.wait();
            console.log('ğŸ‰ Tokens sent! Transaction hash:', receipt.transactionHash);
            console.log(
                'Check token balance on LayerZero Scan: https://testnet.layerzeroscan.com/tx/' +
                receipt.transactionHash,
            );
        });
    ```
    
    ```tsx
    import { EndpointId } from '@layerzerolabs/lz-definitions'
    
    import "./tasks/sendToken" // ì¶”ê°€
    ```
    
    ```bash
    npx hardhat sendToken --network sepolia-testnet --dst-network avalanche-testnet --amount 1000000000000000000
    ```
    
    ![image.png](/assets/post/2025-02-10-layerzero-3/image%2030.png)
    
    - ì•„ë˜ì™€ ê°™ì´ LayerZero Explorerì—ì„œë„ í™•ì¸í•  ìˆ˜ ìˆìŒ
        
        ![image.png](/assets/post/2025-02-10-layerzero-3/image%2031.png)
        
    - Source Chainì—ì„œ ì²˜ë¦¬ ë¨
        
        ![image.png](/assets/post/2025-02-10-layerzero-3/image%2032.png)
        
    - Destination Chain ì²˜ë¦¬
        
        ![image.png](/assets/post/2025-02-10-layerzero-3/image%2033.png)
